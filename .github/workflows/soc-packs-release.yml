name: SOC Packs Release (staging + main)

on:
  push:
    branches:
      - staging
      - main

permissions:
  contents: write   # needed for releases + git push

jobs:
  release-packs:
    # Avoid infinite loop when we commit back with [skip ci]
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest

    env:
      PACKS_DIR: Packs

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # needed to read HEAD^

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install demisto-sdk
        run: |
          pip install "demisto-sdk>=1.0.0"

      # 1) Auto-discover packs (directories with pack_metadata.json)
      - name: Discover packs
        id: discover
        run: |
          python - << 'PY'
          import os
          from pathlib import Path

          packs_dir = Path(os.environ["PACKS_DIR"])
          packs = []
          for p in packs_dir.iterdir():
            if (p / "pack_metadata.json").is_file():
              packs.append(p.name)

          packs_str = " ".join(sorted(packs))
          print("Discovered packs:", packs_str or "(none)")

          with open(os.environ["GITHUB_OUTPUT"], "a") as fh:
            fh.write(f"packs={packs_str}\n")
          PY

      # 2) Compute which packs actually changed version vs HEAD^
      - name: Compute changed packs (version bump)
        id: changed
        run: |
          python - << 'PY'
          import io
          import json
          import os
          import subprocess
          from pathlib import Path

          all_packs = os.environ["ALL_PACKS"].split()
          packs_dir = Path(os.environ["PACKS_DIR"])
          changed = []

          for pack in all_packs:
            meta_path = packs_dir / pack / "pack_metadata.json"
            if not meta_path.is_file():
              continue

            new_meta = json.loads(meta_path.read_text())
            new_ver = (
                new_meta.get("version")
                or new_meta.get("currentVersion")
                or ""
            )

            try:
              blob = subprocess.check_output(
                  ["git", "show", f"HEAD^:{meta_path}"],
                  text=True,
              )
              old_meta = json.load(io.StringIO(blob))
              old_ver = (
                  old_meta.get("version")
                  or old_meta.get("currentVersion")
                  or ""
              )
            except subprocess.CalledProcessError:
              old_ver = ""

            if new_ver != old_ver:
              print(f"{pack}: version changed {old_ver!r} -> {new_ver!r}")
              changed.append(pack)

          changed_str = " ".join(changed)
          print("Changed packs:", changed_str or "(none)")

          with open(os.environ["GITHUB_OUTPUT"], "a") as fh:
            fh.write(f"packs={changed_str}\n")
          PY
        env:
          ALL_PACKS: ${{ steps.discover.outputs.packs }}

      # 3) Decide environment (staging vs main) based on branch
      - name: Determine environment
        id: envinfo
        run: |
          ref="${GITHUB_REF}"
          if [ "$ref" = "refs/heads/staging" ]; then
            ENVIRONMENT="staging"
          elif [ "$ref" = "refs/heads/main" ]; then
            ENVIRONMENT="main"
          else
            echo "Unsupported ref: $ref"
            exit 1
          fi
          echo "environment=$ENVIRONMENT" >> "$GITHUB_OUTPUT"
          echo "Environment: $ENVIRONMENT"

      # 4) Build zips, create releases, update xsoar_config.json
      - name: Build & release changed packs
        if: ${{ steps.changed.outputs.packs != '' }}
        env:
          CHANGED_PACKS: ${{ steps.changed.outputs.packs }}
          ENVIRONMENT: ${{ steps.envinfo.outputs.environment }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # used by gh CLI
        run: |
          python - << 'PY'
          import json
          import os
          import subprocess
          from pathlib import Path

          packs_dir = Path(os.environ["PACKS_DIR"])
          changed = os.environ.get("CHANGED_PACKS", "").split()
          environment = os.environ.get("ENVIRONMENT", "staging")
          repo = os.environ["GITHUB_REPOSITORY"]

          if not changed:
            print("No changed packs to process.")
            raise SystemExit(0)

          dist_dir = Path("dist")
          dist_dir.mkdir(parents=True, exist_ok=True)

          def run_cmd(cmd):
            print("+", " ".join(cmd))
            return subprocess.run(cmd, check=True)

          def gh(*args, check=True):
            print("+ gh", " ".join(args))
            return subprocess.run(["gh", *args], check=check)

          for pack in changed:
            pack_path = packs_dir / pack
            meta_path = pack_path / "pack_metadata.json"
            config_path = pack_path / "xsoar_config.json"

            if not meta_path.exists():
              print(f"Pack {pack}: no pack_metadata.json, skipping.")
              continue

            meta = json.loads(meta_path.read_text())
            version = (
                meta.get("version")
                or meta.get("currentVersion")
                or ""
            )
            if not version:
              print(f"Pack {pack}: no version/currentVersion, skipping.")
              continue

            print(f"Processing {pack} v{version}")

            # Build zip with full pack path
            run_cmd([
                "demisto-sdk", "zip-packs",
                "-i", str(pack_path),
                "-o", str(dist_dir),
            ])

            # demisto-sdk puts zips under dist/uploadable_packs/<pack>.zip
            input_zip = dist_dir / "uploadable_packs" / f"{pack}.zip"
            print("Created zips:")
            for p in (dist_dir / "uploadable_packs").glob("*.zip"):
              print(" ", p)

            if not input_zip.exists():
              raise FileNotFoundError(f"Expected zip {input_zip} not found")

            # Decide tag & asset name
            if environment == "staging":
              tag = f"{pack}-v{version}-staging"
              asset_name = f"{pack}-v{version}-staging.zip"
              title = f"{pack} v{version} (staging)"
              prerelease = True
            else:
              tag = f"{pack}-v{version}"
              asset_name = f"{pack}-v{version}.zip"
              title = f"{pack} v{version}"
              prerelease = False

            final_zip = dist_dir / asset_name
            if final_zip.exists():
              final_zip.unlink()
            input_zip.rename(final_zip)

            # Create or update release
            exists = gh("release", "view", tag, check=False).returncode == 0
            if exists:
              print(f"Release {tag} exists, uploading asset...")
              gh("release", "upload", tag, str(final_zip), "--clobber")
            else:
              print(f"Creating release {tag} ...")
              base = ["release", "create", tag, str(final_zip), "-t", title]
              if prerelease:
                base += [
                  "-n", f"Staging release for {pack} v{version}",
                  "--prerelease",
                ]
              else:
                base += [
                  "-n", f"Release for {pack} v{version}",
                ]
              gh(*base)

            url = f"https://github.com/{repo}/releases/download/{tag}/{asset_name}"
            print(f"New URL for {pack}: {url}")

            if not config_path.exists():
              print(f"Pack {pack}: no xsoar_config.json, skipping URL update.")
              continue

            cfg = json.loads(config_path.read_text())
            cfg["url"] = url
            config_path.write_text(json.dumps(cfg, indent=2) + "\n")

          PY

      # 5) Commit any updated xsoar_config.json files
      - name: Commit updated xsoar_config.json files
        if: ${{ steps.changed.outputs.packs != '' }}
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "${PACKS_DIR}"/*/xsoar_config.json || true

          if git diff --cached --quiet; then
            echo "No staged changes to commit."
            exit 0
          fi

          ENVIRONMENT="${{ steps.envinfo.outputs.environment }}"
          git commit -m "chore: [skip ci] update xsoar_config urls (${ENVIRONMENT})"
          git push origin HEAD

      # 6) No-op if nothing changed
      - name: No packs changed, nothing to do
        if: ${{ steps.changed.outputs.packs == '' }}
        run: |
          echo "No pack version changes detected. Skipping release."
