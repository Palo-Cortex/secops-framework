name: SOC Pack Build & Release (Staging + Prod)

on:
  push:
    branches:
      - staging
      - main

permissions:
  contents: write

env:
  PACKS_DIR: Packs
  DEMISTO_SDK_VERSION: "1.0.0"

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      ########################################################################
      # CHECKOUT
      ########################################################################
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      ########################################################################
      # SETUP PYTHON
      ########################################################################
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      ########################################################################
      # INSTALL DEMISTO SDK
      ########################################################################
      - name: Install demisto-sdk
        run: |
          pip install "demisto-sdk==${DEMISTO_SDK_VERSION}"
          demisto-sdk --version

      ########################################################################
      # DETERMINE ENV (STAGING OR PROD)
      ########################################################################
      - name: Determine Environment
        id: envinfo
        run: |
          if [ "$GITHUB_REF" = "refs/heads/staging" ]; then
            echo "ENVIRONMENT=staging" >> $GITHUB_ENV
            echo "IS_PRERELEASE=true" >> $GITHUB_ENV
          elif [ "$GITHUB_REF" = "refs/heads/main" ]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "IS_PRERELEASE=false" >> $GITHUB_ENV
          else
            echo "Unsupported branch"
            exit 1
          fi

      ########################################################################
      # DISCOVER PACKS
      ########################################################################
      - name: Discover Packs
        id: discover
        run: |
          python - << 'PY'
          import os
          from pathlib import Path

          packs_dir = Path(os.environ["PACKS_DIR"])
          packs = sorted([
              p.name for p in packs_dir.iterdir()
              if (p / "pack_metadata.json").is_file()
          ])

          print("Packs:", packs)
          with open(os.environ["GITHUB_OUTPUT"], "a") as fh:
              fh.write(f"packs={' '.join(packs)}\n")
          PY

      ########################################################################
      # BUILD, RELEASE, UPDATE CONFIG
      ########################################################################
      - name: Build, Release, and Update xsoar_config.json
        env:
          ALL_PACKS: ${{ steps.discover.outputs.packs }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - << 'PY'
          import json, os, shutil, subprocess
          from pathlib import Path

          packs = os.environ["ALL_PACKS"].split()
          packs_dir = Path("Packs")
          environment = os.environ["ENVIRONMENT"]
          prerelease = os.environ["IS_PRERELEASE"] == "true"
          repo = os.environ["GITHUB_REPOSITORY"]

          dist = Path("dist")
          if dist.exists():
            shutil.rmtree(dist)
          dist.mkdir()

          def gh(*args, check=True):
            print("+ gh", " ".join(args))
            return subprocess.run(["gh", *args], check=check)

          for pack in packs:
            print(f"\n=== {pack} ({environment}) ===")

            pack_path = packs_dir / pack
            meta_path = pack_path / "pack_metadata.json"
            config_path = pack_path / "xsoar_config.json"

            meta = json.loads(meta_path.read_text())
            version = meta.get("version") or meta.get("currentVersion")
            if not version:
              print("No version found, skipping")
              continue

            subprocess.run([
              "demisto-sdk", "prepare-content",
              "-i", str(pack_path),
              "-o", "dist",
              "--marketplace", "marketplacev2",
              "--force"
            ], check=True)

            zips = list(dist.glob("*.zip"))
            built_zip = zips[0]

            if environment == "staging":
              tag = f"{pack}-v{version}-staging"
              asset = f"{pack}-v{version}-staging.zip"
            else:
              tag = f"{pack}-v{version}"
              asset = f"{pack}-v{version}.zip"

            release_zip = dist / asset
            shutil.copy(built_zip, release_zip)

            exists = gh("release", "view", tag, check=False).returncode == 0
            if exists:
              gh("release", "upload", tag, str(release_zip), "--clobber")
            else:
              args = ["release", "create", tag, str(release_zip), "-t", tag]
              if prerelease:
                args.append("--prerelease")
              gh(*args)

            url = f"https://github.com/{repo}/releases/download/{tag}/{asset}"
            print("URL:", url)

            if config_path.exists():
              cfg = json.loads(config_path.read_text())
              for entry in cfg.get("custom_packs", []):
                if entry.get("id") == f"{pack}.zip":
                  entry["url"] = url
              config_path.write_text(json.dumps(cfg, indent=2) + "\n")

          PY

      ########################################################################
      # COMMIT UPDATED CONFIGS
      ########################################################################
      - name: Commit Updated xsoar_config.json
        run: |
          if git diff --quiet; then
            echo "No config changes"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Packs/*/xsoar_config.json
          git commit -m "chore: update xsoar_config.json for $ENVIRONMENT"
          git push origin HEAD
