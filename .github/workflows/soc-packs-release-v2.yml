name: SOC Packs Release + POV Staging Test

on:
  push:
    branches:
      - staging
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: write   # required for committing zips + catalog

env:
  PACKS_DIR: Packs
  DIST_DIR: dist
  DEMISTO_SDK_VERSION: "1.38.14"
  DEMISTO_SDK_IGNORE_CONTENT_WARNING: "1"

jobs:
  ###########################################################################
  # JOB â€” Build Pack Zips + Update Catalog
  ###########################################################################
  release-packs:
    # Avoid infinite loop when we commit with [skip ci]
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest

    environment:
      # Just for env separation if you use GitHub environments
      name: ${{ github.ref == 'refs/heads/main' && 'main' || 'staging' }}

    steps:
      # 1) Checkout full history so we can diff properly
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Setup Python + demisto-sdk
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install demisto-sdk
        run: |
          python -m pip install --upgrade pip
          pip install "demisto-sdk==${DEMISTO_SDK_VERSION}"

      # 3) Determine changed packs (based on pack_metadata.json)
      - name: Detect changed packs
        id: changed
        run: |
          set -e

          BASE_SHA="${{ github.event.before }}"
          if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ]; then
            BASE_SHA="${{ github.sha }}~1"
          fi

          echo "Base SHA: $BASE_SHA"
          echo "Head SHA: ${{ github.sha }}"

          CHANGED_FILES=$(git diff --name-only "$BASE_SHA" "${{ github.sha }}" || true)

          echo "Changed files:"
          echo "$CHANGED_FILES"

          PACKS=$(echo "$CHANGED_FILES" \
            | grep -E '^Packs\/[^\/]+\/pack_metadata\.json$' \
            | cut -d'/' -f2 \
            | sort -u \
            | tr '\n' ' ' || true)

          if [ -z "$PACKS" ]; then
            echo "No pack_metadata.json changes detected."
            echo "packs=" >> "$GITHUB_OUTPUT"
          else
            echo "Changed packs: $PACKS"
            echo "packs=$PACKS" >> "$GITHUB_OUTPUT"
            echo "CHANGED_PACKS=$PACKS" >> "$GITHUB_ENV"
          fi

      # 4) Short-circuit if no packs changed
      - name: Stop if no packs changed
        if: steps.changed.outputs.packs == ''
        run: |
          echo "No packs changed. Nothing to do."
          exit 0

      # 5) Zip all changed packs using demisto-sdk zip-packs
      #    (this is exactly what you tested)
      - name: Zip changed packs
        run: |
          set -e
          mkdir -p "${DIST_DIR}"

          for pack in $CHANGED_PACKS; do
            echo "Zipping pack: $pack"
            demisto-sdk zip-packs \
              -i "${PACKS_DIR}/${pack}" \
              -o "${DIST_DIR}"
          done

          echo "Contents of ${DIST_DIR}:"
          ls -la "${DIST_DIR}"

      # 6) Update pack_catalog.json for PoV Companion
      #
      # File: pack_catalog.json (at repo root)
      # Structure:
      # {
      #   "packs": [
      #     {
      #       "id": "soc-framework-unified",
      #       "display_name": "SOC Framework Unified",
      #       "version": "1.3.2",
      #       "url": "https://raw.githubusercontent.com/.../dist/soc-framework-unified.zip",
      #       "include": true
      #     }
      #   ]
      # }
      #
      # IMPORTANT:
      # - New packs default to include = false, so you have manual control.
      # - If a pack already exists in the catalog, we preserve its current
      #   "include" flag and only refresh name/version/url.
      #
      - name: Update pack_catalog.json
        run: |
          set -e

          # Ensure jq is available (usually is, but be explicit)
          sudo apt-get update && sudo apt-get install -y jq

          if [ ! -f pack_catalog.json ]; then
            echo 'pack_catalog.json not found. Creating empty catalog.'
            echo '{"packs": []}' > pack_catalog.json
          fi

          echo "Original pack_catalog.json:"
          cat pack_catalog.json

          BRANCH_NAME="${GITHUB_REF##*/}"
          REPO="${GITHUB_REPOSITORY}"
          BASE_URL="https://raw.githubusercontent.com/${REPO}/${BRANCH_NAME}/${DIST_DIR}"

          echo "Using base URL for zips: ${BASE_URL}"

          TMP_FILE="pack_catalog.tmp.json"
          cp pack_catalog.json "$TMP_FILE"

          for pack in $CHANGED_PACKS; do
            ZIP_NAME="${pack}.zip"
            DOWNLOAD_URL="${BASE_URL}/${ZIP_NAME}"
            META_FILE="${PACKS_DIR}/${pack}/pack_metadata.json"

            if [ ! -f "$META_FILE" ]; then
              echo "WARNING: Missing pack_metadata.json for ${pack}, skipping catalog update for this pack."
              continue
            fi

            DISPLAY_NAME=$(jq -r '.name // .id // ""' "$META_FILE")
            VERSION=$(jq -r '.currentVersion // ""' "$META_FILE")

            if [ -z "$DISPLAY_NAME" ]; then
              DISPLAY_NAME="$pack"
            fi

            echo "Updating catalog entry for pack=${pack}"
            echo "  display_name=${DISPLAY_NAME}"
            echo "  version=${VERSION}"
            echo "  url=${DOWNLOAD_URL}"

            # Preserve existing "include" flag if present, otherwise default false
            EXISTING_INCLUDE=$(jq -r --arg id "$pack" '
              (.packs // [])[]
              | select(.id == $id)
              | .include // ""
            ' "$TMP_FILE" | head -n1 || true)

            if [ "$EXISTING_INCLUDE" = "true" ]; then
              INCLUDE=true
            else
              INCLUDE=false
            fi

            jq \
              --arg id "$pack" \
              --arg name "$DISPLAY_NAME" \
              --arg ver "$VERSION" \
              --arg url "$DOWNLOAD_URL" \
              --argjson include "$INCLUDE" '
              .packs = (
                (.packs // [])
                | map(select(.id != $id))     # remove old entry for this id
                + [ { "id": $id,
                      "display_name": $name,
                      "version": $ver,
                      "url": $url,
                      "include": $include } ]
              )
            ' "$TMP_FILE" > "${TMP_FILE}.new"

            mv "${TMP_FILE}.new" "$TMP_FILE"
          done

          mv "$TMP_FILE" pack_catalog.json

          echo "Updated pack_catalog.json:"
          cat pack_catalog.json

      # 7) Commit zips + catalog back to branch
      - name: Commit catalog & zips (if any changes)
        run: |
          set -e

          git status

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "${DIST_DIR}" pack_catalog.json || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          echo "Committing updated zips and pack catalog..."
          git commit -m "Update pack zips & catalog [skip ci]"
          git push
