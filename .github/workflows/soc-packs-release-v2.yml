name: SOC Packs Release + POV Staging Test

on:
  push:
    branches:
      - staging
      - main

permissions:
  contents: write   # required for committing zips

env:
  PACKS_DIR: Packs
  DIST_DIR: dist
  DEMISTO_SDK_VERSION: "1.38.14"
  DEMISTO_SDK_IGNORE_CONTENT_WARNING: "1"

jobs:
  ###########################################################################
  # JOB â€” Build Pack Zips (no catalog logic)
  ###########################################################################
  release-packs:
    # Avoid infinite loop when we commit with [skip ci]
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest

    environment:
      # For env separation if you use GitHub environments
      name: ${{ github.ref == 'refs/heads/main' && 'main' || 'staging' }}

    steps:
      # 1) Checkout full history so we can diff properly
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Setup Python + demisto-sdk
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install demisto-sdk
        run: |
          python -m pip install --upgrade pip
          pip install "demisto-sdk==${DEMISTO_SDK_VERSION}"

      # 3) Determine changed packs (based on pack_metadata.json)
      - name: Detect changed packs
        id: changed
        run: |
          set -e

          BASE_SHA="${{ github.event.before }}"
          if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ]; then
            BASE_SHA="${{ github.sha }}~1"
          fi

          echo "Base SHA: $BASE_SHA"
          echo "Head SHA: ${{ github.sha }}"

          CHANGED_FILES=$(git diff --name-only "$BASE_SHA" "${{ github.sha }}" || true)

          echo "Changed files:"
          echo "$CHANGED_FILES"

          PACKS=$(echo "$CHANGED_FILES" \
            | grep -E '^Packs\/[^\/]+\/pack_metadata\.json$' \
            | cut -d'/' -f2 \
            | sort -u \
            | tr '\n' ' ' || true)

          if [ -z "$PACKS" ]; then
            echo "No pack_metadata.json changes detected."
            echo "packs=" >> "$GITHUB_OUTPUT"
          else
            echo "Changed packs: $PACKS"
            echo "packs=$PACKS" >> "$GITHUB_OUTPUT"
            echo "CHANGED_PACKS=$PACKS" >> "$GITHUB_ENV"
          fi

      # 4) Short-circuit if no packs changed
      - name: Stop if no packs changed
        if: steps.changed.outputs.packs == ''
        run: |
          echo "No packs changed. Nothing to do."
          exit 0

      # 5) Zip all changed packs using demisto-sdk zip-packs
      #    (this matches the command you tested)
      - name: Zip changed packs
        run: |
          set -e
          mkdir -p "${DIST_DIR}"

          for pack in $CHANGED_PACKS; do
            echo "Zipping pack: $pack"
            demisto-sdk zip-packs \
              -i "${PACKS_DIR}/${pack}" \
              -o "${DIST_DIR}"
          done

          echo "Contents of ${DIST_DIR}:"
          ls -la "${DIST_DIR}"

      # 6) Commit zips back to branch (no catalog)
      - name: Commit zips (if any changes)
        run: |
          set -e

          git status

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "${DIST_DIR}" || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          echo "Committing updated pack zips..."
          git commit -m "Update pack zips [skip ci]"
          git push
