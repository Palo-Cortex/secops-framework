name: SOC Packs Validate

on:
  pull_request:
    branches:
      - develop
  push:
    branches:
      - develop

permissions:
  contents: read

env:
  PACKS_DIR: Packs
  DEMISTO_SDK_VERSION: "1.38.14"
  DEMISTO_SDK_IGNORE_CONTENT_WARNING: "1"

jobs:
  validate-packs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install demisto-sdk
        run: pip install "demisto-sdk==${DEMISTO_SDK_VERSION}"

      - name: Verify demisto-sdk version
        run: |
          VER=$(demisto-sdk --version | grep -Eo '([0-9]+\.)+[0-9]+' | head -1)
          echo "SDK version = $VER"
          if [ "$VER" != "${DEMISTO_SDK_VERSION}" ]; then
            echo "ERROR: Expected demisto-sdk ${DEMISTO_SDK_VERSION}"
            exit 1
          fi

      ###################################################################
      # Discover all packs (comma-separated output)
      ###################################################################
      - name: Discover packs
        id: discover
        run: |
          python - << 'PY'
          import os
          from pathlib import Path

          packs_dir = Path(os.environ["PACKS_DIR"])
          packs = sorted(
              p.name for p in packs_dir.iterdir()
              if (p / "pack_metadata.json").is_file()
          )

          packs_str = ",".join(packs)
          print("Discovered packs:", packs_str or "(none)")

          with open(os.environ["GITHUB_OUTPUT"], "a") as fh:
              fh.write(f"packs={packs_str}\n")
          PY

      ###################################################################
      # Determine which packs changed (version bump)
      ###################################################################
      - name: Determine changed packs
        id: changed
        env:
          ALL_PACKS: ${{ steps.discover.outputs.packs }}
        run: |
          python - << 'PY'
          import io, json, os, subprocess
          from pathlib import Path

          all_packs = os.environ.get("ALL_PACKS", "")
          if all_packs:
            packs = [p for p in all_packs.split(",") if p]
          else:
            packs = []

          packs_dir = Path(os.environ["PACKS_DIR"])
          changed = []

          for pack in packs:
            meta_path = packs_dir / pack / "pack_metadata.json"
            if not meta_path.exists():
              continue

            new_meta = json.loads(meta_path.read_text())
            new_ver = new_meta.get("version") or new_meta.get("currentVersion") or ""

            try:
              blob = subprocess.check_output(
                ["git", "show", f"HEAD^:{meta_path}"], text=True
              )
              old_meta = json.load(io.StringIO(blob))
              old_ver = old_meta.get("version") or old_meta.get("currentVersion") or ""
            except subprocess.CalledProcessError:
              old_ver = ""

            if new_ver != old_ver:
              print(f"{pack}: version changed {old_ver} -> {new_ver}")
              changed.append(pack)

          out = ",".join(changed)
          print("Changed packs:", out or "(none)")

          with open(os.environ["GITHUB_OUTPUT"], "a") as fh:
            fh.write(f"packs={out}\n")
          PY

      ###################################################################
      # Bail out if nothing changed
      ###################################################################
      - name: Fail early if no packs changed
        if: ${{ steps.changed.outputs.packs == '' }}
        run: |
          echo "No pack version changes detected; nothing to validate."
          exit 0

      ###################################################################
      # Run normalize + demisto-sdk validate on changed packs
      ###################################################################
      - name: Run normalize + demisto-sdk validate
        env:
          CHANGED_PACKS: ${{ steps.changed.outputs.packs }}
        run: |
          set -euo pipefail

          RAW="${CHANGED_PACKS:-}"
          IFS=',' read -r -a PACK_ARRAY <<< "$RAW"

          echo "Changed packs: ${PACK_ARRAY[*]}"

          for PACK in "${PACK_ARRAY[@]}"; do
            [ -z "$PACK" ] && continue
            PACK_PATH="${PACKS_DIR}/${PACK}"
            echo "=== Normalizing + validating pack: ${PACK} (${PACK_PATH}) ==="

            # Your normalize script, if you want it here:
            python tools/normalize_ruleid_adopted.py --root "$PACK_PATH"

            demisto-sdk validate -i "$PACK_PATH" --no-docker-checks
          done
